# Руководство по написанию модульных тестов

## Общие требования

1. Используй фреймворк xUnit для написания тестов.
2. Всегда используйте общий контекст `IClassFixture<TestFixture>`, в котором инициализируйте IOC-контейнер.
3. Для мокирования зависимостей используйте библиотеку Moq.
4. Каждый тест должен проверять только один сценарий (один аспект поведения).
5. Имена тестовых методов должны быть самодокументируемыми и описывать проверяемое поведение, например:  
   `CreateAsync_Throws_Exception_For_Empty_Name`
6. Для проверки граничных случаев используйте `[Theory]` и `[InlineData]`.
7. Если ошибка возникает до использования мока, мок не создаётся.
8. Моки создаются только для реально используемых зависимостей.
9. Для проверки коллекций ошибок используйте `Assert.Contains` и `Assert.Empty` по необходимости.
10. Не используйте комментарии внутри строк кода только для разделения блоков Arrange/Act/Assert.
11. Не тестируйте детали реализации, тестируйте только публичное поведение.
12. Библиотеку AutoMapper не мокируйте, а берите из DI-контейнера.
13. Каждый индивидуальный тест сопровождайте аннотацией в виде комментариев к методу, записанной в стиле `При таких-то условиях метод должен вести себя так-то`
14. Блоки Act и Assert нужно разделять пустой строкой 
15. Для Arrange этапа должны использоваться AutoFixture или фабричный метод при определении данных
Пример для фаричного метода:
Сначала создать дополнительный класс, который реализует в себе все методы по заполнению данными класса. Далее использовать как в примере:
            var lot = new LotBuilder() 
                .WithCreatedUserId(Guid.NewGuid().ToString())
                .Build();
				
16. Для Stub и Mock использовать Moq;
17. Для создания тестируемого класса, например, PartnersController можно использовать AutoFixture, чтобы избежать ошибок компиляции при добавлении новых зависимостей в конструктор или также использовать фабричный метод;
Пример:
// Пример с AutoFixture + Moq
var fixture = new Fixture().Customize(new AutoMoqCustomization());
var controller = fixture.Create<PartnersController>();

18. Для проверки утверждения в тестах должен использоваться FluentAssertions;
19. В качестве дополнительного условия тестовые данные должны формироваться с помощью Builder (смотерть пример пункта 17), и тогда Mock и Stub также должны настраиваться через Builder, или через AutoFixture

```csharp
[Fact]
public async Task MethodName_ExpectedBehavior_WhenCondition()
{
    // Arrange
    // ... подготовка данных и моков

    // Act
    // ... вызов тестируемого метода

    // Assert
    // ... проверки результата
}

```

## Пример использования Theory

```csharp

[Theory]
[InlineData("")]
[InlineData(null)]
public async Task MethodName_ThrowsException_ForInvalidInput(string input)
{
    // Arrange
    // ...

    // Act
    // ...

    // Assert
    // ...
}

```

## Пример использования Moq

```csharp

var dependencyMock = new Mock<IDependency>();
dependencyMock.Setup(m => m.Method()).ReturnsAsync(value);

```

## Пример проверки ошибок

```csharp

Assert.Contains(ExpectedError, result.Errors);
Assert.Empty(result.Errors);

```